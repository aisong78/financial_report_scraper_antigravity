# 产品架构设计文档

> **文档目标**: 记录产品设计思路、架构决策和版本演进路线，供产品经理和开发团队参考

---

## 📋 产品定位

### 核心痛点
1. **信息分散**: 财务数据散落在不同平台（交易所官网、第三方数据商），查询成本高
2. **格式不统一**: PDF 财报难以提取，缺乏结构化数据
3. **数据质量参差**: 第三方数据可能有错误，缺乏验证机制
4. **分析门槛高**: 需要手动计算指标，对非专业人士不友好

### 目标用户
- **个人投资者**: 需要快速查看财务数据，但不想付费使用 Wind/Bloomberg
- **财务分析师**: 需要批量处理财报，提取关键指标
- **量化研究员**: 需要干净、可验证的历史数据用于回测

### 产品愿景
**打造一个免费、开源、可验证的财务数据分析平台**

---

## 🏗️ 架构设计哲学

### 设计原则

#### 1. 数据可靠性优先
**决策**: 不盲目信任任何单一数据源  
**实现**: 
- 双数据源（AkShare API + PDF 原文）交叉验证
- 每条数据带 `data_quality` 标记（VERIFIED/UNVERIFIED/CONFLICT）
- 数据差异超过 2% 时标记为冲突，提示人工复核

**取舍**: 牺牲了一些处理速度（需要下载和解析 PDF），换取数据可靠性

---

#### 2. 渐进式数据获取
**决策**: 不强制用户一开始就下载所有数据  
**实现**: 
- **快速通道**: 优先展示 AkShare 的结构化数据（秒级）
- **深度通道**: 按需下载 PDF 原文（分钟级）
- **后台预抓**: 对关注列表的股票，定时下载最新财报

**取舍**: 初次使用体验好，但深度分析需要等待

---

#### 3. 本地优先存储
**决策**: 使用 SQLite 本地数据库，而非云端数据库  
**实现**: 
- 数据存储在用户本地 `finance.db`
- 文件存储在用户本地 `downloads/` 文件夹

**优势**: 
- 无需付费云服务
- 数据隐私完全可控
- 离线可用

**劣势**: 
- 不支持多设备同步
- 协作场景受限

**未来演进**: v2.0 可增加可选的云端同步功能

---

#### 4. 可扩展的多市场架构
**决策**: 从一开始就设计为多市场支持  
**实现**: 
- 数据库字段设计兼容 A/港/美三地（`currency` 字段）
- 下载器通过股票代码自动识别市场类型
- 采用不同的数据源接口（A股用 AkShare，美股用 SEC）

**设计模式**: 策略模式（Strategy Pattern）
```python
def download(stock_code):
    if is_a_stock(stock_code):
        return download_from_akshare()
    elif is_us_stock(stock_code):
        return download_from_sec()
```

---

## 📐 数据流设计

### 核心数据流

```
用户请求 → 查询本地数据库 → 有数据？
                               ├─ 是 → 直接展示
                               └─ 否 → 触发数据抓取
                                       ↓
                           [ 抓取 AkShare 数据 ]
                                       ↓
                           [ 存入 raw 表 ]
                                       ↓
                           [ 计算衍生指标 ]
                                       ↓
                           [ 存入 derived 表 ]
                                       ↓
                           [ 下载 PDF（可选）]
                                       ↓
                           [ 解析为 TXT ]
                                       ↓
                           [ 交叉验证 ]
                                       ↓
                           [ 更新 data_quality ]
                                       ↓
                                   展示给用户
```

### 数据库设计思路

#### 表结构分层

| 层级 | 表名 | 职责 | 数据来源 |
|------|------|------|----------|
| **原始层** | `financial_reports_raw` | 存储未加工的财务数据 | AkShare API |
| **计算层** | `financial_indicators_derived` | 存储计算得出的指标 | 基于 raw 表计算 |
| **文件层** | `financial_reports_files` | 记录下载的文件路径 | PDF 下载器 |
| **元数据层** | `metric_definitions` | 存储指标的定义和标准 | 手动维护 |

#### 关键设计决策

**Q: 为什么不把衍生指标直接放在 raw 表里？**  
A: 分层设计的好处：
- 原始数据和计算数据分离，便于调试
- 如果计算逻辑调整（如 ROE 公式优化），只需重新计算 derived 表
- 未来可以支持用户自定义指标

**Q: 为什么需要 `financial_reports_files` 表？**  
A: 记录文件路径的好处：
- 支持"查看原文"功能（在界面上直接打开 PDF/TXT）
- 跟踪解析状态（成功/失败），便于排查 PDF 解析问题
- 支持批量重新解析（如果解析逻辑优化了）

---

## 🔄 版本迭代设计

### v0.1 (MVP) - 数据抓取验证
**目标**: 验证技术可行性  
**功能**:
- ✅ AkShare 接口调试
- ✅ SQLite 数据库搭建
- ✅ 简单的 Streamlit 界面（Mock 数据）

**核心问题**:
- AkShare 数据是否稳定？→ 是，但有时会返回未来日期
- SQLite 性能是否够用？→ 对于个人用户足够

---

### v1.0 (当前版本) - 数据闭环
**目标**: 实现完整的数据获取→计算→验证→展示闭环  
**新增功能**:
- ✅ 财务指标自动计算（15+ 指标）
- ✅ Streamlit 数据看板（全中文、可筛选）
- ✅ PDF 下载与解析
- ✅ 数据交叉验证引擎

**设计升级**:
- 引入 `session_state` 解决 Streamlit 交互问题
- 增加 `data_quality` 字段确保数据可靠性
- 增加 `financial_reports_files` 表支持文件管理

**已知问题**:
- PDF 解析准确度依赖文件质量（复杂表格可能识别错误）
- 标题解析逻辑较简单（半年报曾被误判为年报）→ 已修复

---

### v1.1 (下一版本) - 用户体验优化
**目标**: 提升数据透明度和可追溯性  
**计划功能**:
- [ ] Streamlit 界面显示数据质量标识（✅/⚠️/❌）
- [ ] 增加"查看原文"按钮（直接在线预览 TXT）
- [ ] 支持手动触发"重新验证"
- [ ] 港股和美股数据的界面展示

**设计重点**:
- 让用户清楚知道"这个数字是否经过验证"
- 提供原文查看入口，增强信任感

---

### v2.0 (远期规划) - AI 增强
**目标**: 从"数据展示工具"进化为"智能分析助手"  
**计划功能**:
- [ ] LLM 集成（Gemini API）
- [ ] 财报智能问答（"管理层对 2025 年有什么展望？"）
- [ ] MD&A 自动提取与总结
- [ ] 多股票对比分析
- [ ] TTM 指标计算（滚动 12 个月数据）

**技术挑战**:
- LLM 成本控制（每份财报可能上万 token）
- 回答准确性（避免 LLM 幻觉）
- 上下文管理（财报 PDF 可能上百页）

**设计思路**:
- 先用 PDF 解析提取关键段落（如 MD&A 章节）
- 再把精简后的文本喂给 LLM
- 缓存 LLM 回答，避免重复调用

---

## 🎯 功能模块划分

### 模块矩阵

| 模块 | 优先级 | 复杂度 | 依赖 | 状态 |
|------|--------|--------|------|------|
| **数据抓取** | P0 | 低 | AkShare | ✅ 已完成 |
| **指标计算** | P0 | 中 | 数据抓取 | ✅ 已完成 |
| **数据展示** | P0 | 中 | 指标计算 | ✅ 已完成 |
| **PDF 下载** | P1 | 中 | - | ✅ 已完成 |
| **PDF 解析** | P1 | 中 | PDF 下载 | ✅ 已完成 |
| **数据验证** | P1 | 高 | PDF 解析 | ✅ 已完成 |
| **质量标识** | P2 | 低 | 数据验证 | 🚧 进行中 |
| **查看原文** | P2 | 低 | PDF 解析 | 🚧 进行中 |
| **LLM 问答** | P3 | 高 | PDF 解析 | 📋 计划中 |
| **多股对比** | P3 | 中 | 数据展示 | 📋 计划中 |

### 模块间依赖关系

```
数据抓取 (data_fetcher)
    ↓
指标计算 (calculator)
    ↓
数据展示 (app.py) ←──────┐
    ↑                     │
PDF 下载 (pdf_downloader)  │
    ↑                     │
PDF 解析 (pdf_parser)      │
    ↑                     │
数据验证 (validator) ──────┘
```

---

## 🔧 技术选型决策

### 为什么选 Streamlit？
**备选方案**: Flask + React, Django, Dash  
**最终选择**: Streamlit  
**原因**:
- ✅ 快速开发（纯 Python，无需前端技能）
- ✅ 自带美观的 UI 组件
- ✅ 适合数据科学场景
- ❌ 性能不如 React（但对个人用户够用）
- ❌ 定制化受限（但可以通过 custom components 扩展）

---

### 为什么选 SQLite？
**备选方案**: MySQL, PostgreSQL, MongoDB  
**最终选择**: SQLite  
**原因**:
- ✅ 零配置（无需安装数据库服务器）
- ✅ 单文件存储，便于备份和迁移
- ✅ 对于单用户场景性能足够
- ❌ 不支持并发写入（但本项目是单用户单线程）
- ❌ 缺乏一些高级特性（但暂不需要）

**升级路径**: v2.0 如果需要多用户协作，可迁移到 PostgreSQL

---

### 为什么选 PyMuPDF？
**备选方案**: pdfplumber, PyPDF2, Camelot  
**最终选择**: PyMuPDF (fitz)  
**原因**:
- ✅ 速度最快
- ✅ 对中文支持最好
- ✅ 文本提取最准确
- ❌ 表格识别不如 pdfplumber（后续可组合使用）

---

## 🚧 已知技术债务

### 1. PDF 解析准确性
**现状**: 简单的文本提取，复杂表格可能识别错误  
**影响**: 中  
**解决方案**:
- 短期: 增加正则表达式的健壮性
- 中期: 引入 pdfplumber 做表格识别
- 长期: 用 LLM 辅助提取（让 AI 理解上下文）

---

### 2. 单元测试缺失
**现状**: 0% 测试覆盖率  
**影响**: 高（重构时容易引入 bug）  
**解决方案**:
- v1.1: 为核心模块（calculator, validator）添加单元测试
- 目标覆盖率: 60%+

---

### 3. 异常处理不完善
**现状**: 网络超时、文件损坏等异常未充分处理  
**影响**: 中  
**解决方案**:
- 增加 try-catch 覆盖
- 引入日志系统（替代 print）
- 增加重试机制

---

## 📊 性能指标

### 当前性能基准
- **数据抓取**: ~2 秒/只股票（AkShare API）
- **指标计算**: ~0.1 秒/报告期
- **PDF 下载**: ~1 秒/文件（受网速影响）
- **PDF 解析**: ~2 秒/文件（100 页以内）
- **数据验证**: ~0.5 秒/报告期

### 性能瓶颈
- **网络 I/O**: PDF 下载受巨潮资讯服务器限速影响
- **正则匹配**: 大文件（>200 页）解析较慢

### 优化方向
- 批量下载时增加并发控制（asyncio + aiohttp）
- PDF 解析增加多进程支持

---

## 🎓 设计思想总结

1. **数据可靠性 > 处理速度**: 宁可慢一点，也要保证数据准确
2. **本地优先 > 云端**: 尊重用户数据隐私，降低依赖成本
3. **渐进式增强 > 一次到位**: 先做 MVP，再迭代优化
4. **可扩展性 > 立即实现**: 架构设计要为未来留空间

---

## 📝 给产品经理的建议

### 如何判断需求优先级？
使用 RICE 模型：
- **Reach (影响人数)**: 这个功能会影响多少用户？
- **Impact (影响程度)**: 对单个用户的价值有多大？
- **Confidence (把握程度)**: 我们有多确定这个需求是对的？
- **Effort (开发成本)**: 需要多少人天？

示例：
- LLM 问答: Reach=高, Impact=高, Confidence=中, Effort=高 → RICE = 6
- 查看原文: Reach=中, Impact=中, Confidence=高, Effort=低 → RICE = 9 ✅ 优先

---

## 🔗 相关文档

- [开发日志](DEVLOG.md) - 详细的开发记录
- [README.md](../README.md) - 用户使用文档
- [CHANGELOG.md](../CHANGELOG.md) - 版本变更日志
